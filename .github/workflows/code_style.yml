name: Code Quality Checks

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  python-quality-check:
    name: Python Code Quality Check
    runs-on: ubuntu-latest

    if: |
      !(
        github.event_name == 'push' && 
        github.actor == 'github-actions[bot]' && 
        (
          github.event.commits[0].message contains 'style: auto-format Python'
        )
      )
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.event.pull_request.head.ref || github.ref }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install Python dependencies
      run: pip install ruff==0.14.6

    - name: Run Python quality check
      id: python-check
      continue-on-error: true
      run: make quality

    - name: Auto-fix Python formatting
      id: auto-fix-python
      if: steps.python-check.outcome == 'failure' && github.event_name == 'pull_request'
      run: |
        echo "Attempting to auto-fix Python formatting issues..."
        make style

        if git diff --quiet; then
          echo "No changes to commit after auto-fix"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "Changes detected, committing fixes..."
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add -A
        git commit -m "style: auto-format Python code with ruff"
        echo "has_changes=true" >> $GITHUB_OUTPUT

        echo "Pushing changes..."
        git push origin HEAD:${{ github.event.pull_request.head.ref || github.ref_name }}

    - name: Comment on PR for Python fixes
      if: steps.auto-fix-python.outcome == 'success' && fromJson(steps.auto-fix-python.outputs.has_changes)
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });
          
          const hasExistingComment = comments.some(comment => 
            comment.user.login === 'github-actions[bot]' && 
            comment.body.includes('Python formatting')
          );
          
          if (!hasExistingComment) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚úÖ **Python Code Formatting Applied**\n\nI\'ve automatically formatted your Python code using `ruff`. The changes have been pushed to your branch. Please review the changes and update your PR if needed.'
            });
          }

    - name: Fail if Python check failed and not auto-fixed
      if: steps.python-check.outcome == 'failure' && (steps.auto-fix-python.outcome == 'failure' || github.event_name != 'pull_request')
      run: |
        echo "Python quality check failed"
        echo "For PRs, auto-fix was attempted. Check the auto-fix step for details."
        exit 1

  cpp-quality-check:
    name: C++ Code Quality Check
    runs-on: ubuntu-latest
    
    if: |
      !(
        github.event_name == 'push' && 
        github.actor == 'github-actions[bot]' && 
        (
          github.event.commits[0].message contains 'style: auto-format C++'
        )
      )
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.event.pull_request.head.ref || github.ref }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install clang-format via pip
      run: pip install clang-format==21.1.8

    - name: Run C++ quality check
      id: cpp-check
      continue-on-error: true
      run: make cquality

    - name: Auto-fix C++ formatting
      id: auto-fix-cpp
      if: steps.cpp-check.outcome == 'failure' && github.event_name == 'pull_request'
      run: |
        echo "Attempting to auto-fix C++ formatting issues..."
        make cstyle
        
        if git diff --quiet; then
          echo "No changes to commit after auto-fix"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Changes detected, committing fixes..."
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add -A
        git commit -m "style: auto-format C++ code with clang-format"
        echo "has_changes=true" >> $GITHUB_OUTPUT
        
        echo "Pushing changes..."
        git push origin HEAD:${{ github.event.pull_request.head.ref || github.ref_name }}

    - name: Comment on PR for C++ fixes
      if: steps.auto-fix-cpp.outcome == 'success' && fromJson(steps.auto-fix-cpp.outputs.has_changes)
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });
  
          const hasExistingComment = comments.some(comment => 
            comment.user.login === 'github-actions[bot]' && 
            comment.body.includes('C++ formatting')
          );
          
          if (!hasExistingComment) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚úÖ **C++ Code Formatting Applied**\n\nI\'ve automatically formatted your C++ code using `clang-format`. The changes have been pushed to your branch. Please review the changes and update your PR if needed.'
            });
          }

    - name: Fail if C++ check failed and not auto-fixed
      if: steps.cpp-check.outcome == 'failure' && (steps.auto-fix-cpp.outcome == 'failure' || github.event_name != 'pull_request')
      run: |
        echo "C++ quality check failed"
        echo "For PRs, auto-fix was attempted. Check the auto-fix step for details."
        exit 1

  summary-comment:
    name: Formatting Summary
    needs: [python-quality-check, cpp-quality-check]
    if: github.event_name == 'pull_request' && (needs.python-quality-check.outputs.has_changes == 'true' || needs.cpp-quality-check.outputs.has_changes == 'true')
    runs-on: ubuntu-latest
    
    steps:
    - name: Post formatting summary
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const pythonFixed = "${{ needs.python-quality-check.outputs.has_changes }}" === 'true';
          const cppFixed = "${{ needs.cpp-quality-check.outputs.has_changes }}" === 'true';
          
          let summary = '## üìù Formatting Summary\n\n';
          
          if (pythonFixed && cppFixed) {
            summary += '‚úÖ Both Python and C++ code have been automatically formatted.\n';
            summary += '‚úÖ All formatting issues are now resolved.';
          } else if (pythonFixed) {
            summary += '‚úÖ Python code has been automatically formatted.\n';
            summary += '‚úÖ C++ code passed formatting checks without changes.';
          } else if (cppFixed) {
            summary += '‚úÖ C++ code has been automatically formatted.\n';
            summary += '‚úÖ Python code passed formatting checks without changes.';
          }
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: summary
          });
